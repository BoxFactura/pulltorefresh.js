{"version":3,"file":"pulltorefresh.min.js","sources":["../src/lib/index.js"],"sourcesContent":["'use strict';\n\nconst _ptrMarkup = `\n<div class=\"__PREFIX__box\">\n  <div class=\"__PREFIX__content\">\n    <div class=\"__PREFIX__icon\"></div>\n    <div class=\"__PREFIX__text\"></div>\n  </div>\n</div>\n`;\n\nconst _ptrStyles = `\n.__PREFIX__ptr {\n  box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.12);\n  pointer-events: none;\n  font-size: 0.85em;\n  font-weight: bold;\n  top: 0;\n  height: 0;\n  transition: height 0.3s, min-height 0.3s;\n  text-align: center;\n  width: 100%;\n  overflow: hidden;\n  display: flex;\n  align-items: flex-end;\n  align-content: stretch;\n}\n\n.__PREFIX__box {\n  padding: 10px;\n  flex-basis: 100%;\n}\n\n.__PREFIX__pull {\n  transition: none;\n}\n\n.__PREFIX__text {\n  margin-top: .33em;\n  color: rgba(0, 0, 0, 0.3);\n}\n\n.__PREFIX__icon {\n  color: rgba(0, 0, 0, 0.3);\n  transition: transform .3s;\n}\n\n/*\nWhen at the top of the page, disable vertical overscroll so passive touch\nlisteners can take over.\n*/\n.__PREFIX__top {\n  touch-action: pan-x pan-down pinch-zoom;\n}\n\n.__PREFIX__release {\n  .__PREFIX__icon {\n    transform: rotate(180deg);\n  }\n}\n`;\n\nconst _defaults = {\n  distThreshold: 60,\n  distMax: 80,\n  distReload: 50,\n  distIgnore: 0,\n  bodyOffset: 20,\n  mainElement: 'body',\n  triggerElement: 'body',\n  ptrElement: '.ptr',\n  classPrefix: 'ptr--',\n  cssProp: 'min-height',\n  iconArrow: '&#8675;',\n  iconRefreshing: '&hellip;',\n  instructionsPullToRefresh: 'Pull down to refresh',\n  instructionsReleaseToRefresh: 'Release to refresh',\n  instructionsRefreshing: 'Refreshing',\n  refreshTimeout: 500,\n  getMarkup: () => _ptrMarkup,\n  getStyles: () => _ptrStyles,\n  onInit: () => {},\n  onRefresh: () => location.reload(),\n  resistanceFunction: t => Math.min(1, t / 2.5),\n  shouldPullToRefresh: () => !window.scrollY,\n};\n\nconst _methods = ['mainElement', 'ptrElement', 'triggerElement'];\n\nconst _shared = {\n  pullStartY: null,\n  pullMoveY: null,\n  handlers: [],\n  styleEl: null,\n  events: null,\n  dist: 0,\n  state: 'pending',\n  timeout: null,\n  distResisted: 0,\n  supportsPassive: false,\n};\n\ntry {\n  window.addEventListener('test', null, {\n    get passive() { // eslint-disable-line getter-return\n      _shared.supportsPassive = true;\n    },\n  });\n} catch (e) {\n  // do nothing\n}\n\nconst _ptr = {\n  setupDOM(handler) {\n    if (!handler.ptrElement) {\n      const ptr = document.createElement('div');\n\n      if (handler.mainElement !== document.body) {\n        handler.mainElement.parentNode.insertBefore(ptr, handler.mainElement);\n      } else {\n        document.body.insertBefore(ptr, document.body.firstChild);\n      }\n\n      ptr.classList.add(`${handler.classPrefix}ptr`);\n      ptr.innerHTML = handler.getMarkup()\n        .replace(/__PREFIX__/g, handler.classPrefix);\n\n      handler.ptrElement = ptr;\n\n      if (typeof handler.onInit === 'function') {\n        handler.onInit(handler);\n      }\n\n      // Add the css styles to the style node, and then\n      // insert it into the dom\n      if (!_shared.styleEl) {\n        _shared.styleEl = document.createElement('style');\n        _shared.styleEl.setAttribute('id', 'pull-to-refresh-js-style');\n\n        document.head.appendChild(_shared.styleEl);\n      }\n\n      _shared.styleEl.textContent = handler.getStyles()\n        .replace(/__PREFIX__/g, handler.classPrefix)\n        .replace(/\\s+/g, ' ');\n    }\n\n    return handler;\n  },\n  onReset(handler) {\n    handler.ptrElement.classList.remove(`${handler.classPrefix}refresh`);\n    handler.ptrElement.style[handler.cssProp] = '0px';\n\n    setTimeout(() => {\n      // remove previous ptr-element from DOM\n      if (handler.ptrElement && handler.ptrElement.parentNode) {\n        handler.ptrElement.parentNode.removeChild(handler.ptrElement);\n        handler.ptrElement = null;\n      }\n\n      // reset state\n      _shared.state = 'pending';\n    }, handler.refreshTimeout);\n  },\n  update(handler) {\n    const iconEl = handler.ptrElement.querySelector(`.${handler.classPrefix}icon`);\n    const textEl = handler.ptrElement.querySelector(`.${handler.classPrefix}text`);\n\n    if (iconEl) {\n      if (_shared.state === 'refreshing') {\n        iconEl.innerHTML = handler.iconRefreshing;\n      } else {\n        iconEl.innerHTML = handler.iconArrow;\n      }\n    }\n\n    if (textEl) {\n      if (_shared.state === 'releasing') {\n        textEl.innerHTML = handler.instructionsReleaseToRefresh;\n      }\n\n      if (_shared.state === 'pulling' || _shared.state === 'pending') {\n        textEl.innerHTML = handler.instructionsPullToRefresh;\n      }\n\n      if (_shared.state === 'refreshing') {\n        textEl.innerHTML = handler.instructionsRefreshing;\n      }\n    }\n  },\n};\n\nfunction _setupEvents() {\n  let _el;\n\n  function _onTouchStart(e) {\n    // here, we must pick a handler first, and then append their html/css on the DOM\n    const target = _shared.handlers.filter(h => h.contains(e.target))[0];\n\n    _shared.enable = !!target;\n\n    if (target && _shared.state === 'pending') {\n      _el = _ptr.setupDOM(target);\n\n      if (target.shouldPullToRefresh()) {\n        _shared.pullStartY = e.touches[0].screenY;\n      }\n\n      clearTimeout(_shared.timeout);\n\n      _ptr.update(target);\n    }\n  }\n\n  function _onTouchMove(e) {\n    if (!(_el && _el.ptrElement && _shared.enable)) {\n      return;\n    }\n\n    if (!_shared.pullStartY) {\n      if (_el.shouldPullToRefresh()) {\n        _shared.pullStartY = e.touches[0].screenY;\n      }\n    } else {\n      _shared.pullMoveY = e.touches[0].screenY;\n    }\n\n    if (_shared.state === 'refreshing') {\n      if (_el.shouldPullToRefresh() && _shared.pullStartY < _shared.pullMoveY) {\n        e.preventDefault();\n      }\n\n      return;\n    }\n\n    if (_shared.state === 'pending') {\n      _el.ptrElement.classList.add(`${_el.classPrefix}pull`);\n      _shared.state = 'pulling';\n      _ptr.update(_el);\n    }\n\n    if (_shared.pullStartY && _shared.pullMoveY) {\n      _shared.dist = _shared.pullMoveY - _shared.pullStartY;\n    }\n\n    _shared.distExtra = _shared.dist - _el.distIgnore;\n\n    if (_shared.distExtra > 0) {\n      e.preventDefault();\n\n      _el.ptrElement.style[_el.cssProp] = `${_shared.distResisted}px`;\n\n      _shared.distResisted = _el.resistanceFunction(_shared.distExtra / _el.distThreshold)\n        * Math.min(_el.distMax, _shared.distExtra);\n\n      if (_shared.state === 'pulling' && _shared.distResisted > _el.distThreshold) {\n        _el.ptrElement.classList.add(`${_el.classPrefix}release`);\n        _shared.state = 'releasing';\n        _ptr.update(_el);\n      }\n\n      if (_shared.state === 'releasing' && _shared.distResisted < _el.distThreshold) {\n        _el.ptrElement.classList.remove(`${_el.classPrefix}release`);\n        _shared.state = 'pulling';\n        _ptr.update(_el);\n      }\n    }\n  }\n\n  function _onTouchEnd() {\n    if (!(_el && _el.ptrElement && _shared.enable)) {\n      return;\n    }\n\n    if (_shared.state === 'releasing' && _shared.distResisted > _el.distThreshold) {\n      _shared.state = 'refreshing';\n\n      _el.ptrElement.style[_el.cssProp] = `${_el.distReload}px`;\n      _el.ptrElement.classList.add(`${_el.classPrefix}refresh`);\n\n      _shared.timeout = setTimeout(() => {\n        const retval = _el.onRefresh(() => _ptr.onReset(_el));\n\n        if (retval && typeof retval.then === 'function') {\n          retval.then(() => _ptr.onReset(_el));\n        }\n\n        if (!retval && !_el.onRefresh.length) {\n          _ptr.onReset(_el);\n        }\n      }, _el.refreshTimeout);\n    } else {\n      if (_shared.state === 'refreshing') {\n        return;\n      }\n\n      _el.ptrElement.style[_el.cssProp] = '0px';\n\n      _shared.state = 'pending';\n    }\n\n    _ptr.update(_el);\n\n    _el.ptrElement.classList.remove(`${_el.classPrefix}release`);\n    _el.ptrElement.classList.remove(`${_el.classPrefix}pull`);\n\n    _shared.pullStartY = _shared.pullMoveY = null;\n    _shared.dist = _shared.distResisted = 0;\n  }\n\n  function _onScroll() {\n    if (_el) {\n      _el.mainElement.classList.toggle(`${_el.classPrefix}top`, _el.shouldPullToRefresh());\n    }\n  }\n\n  const _passiveSettings = _shared.supportsPassive\n    ? { passive: _shared.passive || false }\n    : undefined;\n\n  window.addEventListener('touchend', _onTouchEnd);\n  window.addEventListener('touchstart', _onTouchStart);\n  window.addEventListener('touchmove', _onTouchMove, _passiveSettings);\n  window.addEventListener('scroll', _onScroll);\n\n  return {\n    onTouchEnd: _onTouchEnd,\n    onTouchStart: _onTouchStart,\n    onTouchMove: _onTouchMove,\n    onScroll: _onScroll,\n\n    destroy() {\n      // Teardown event listeners\n      window.removeEventListener('touchstart', _onTouchStart);\n      window.removeEventListener('touchend', _onTouchEnd);\n      window.removeEventListener('touchmove', _onTouchMove, _passiveSettings);\n      window.removeEventListener('scroll', _onScroll);\n    },\n  };\n}\n\nfunction _setupHandler(options) {\n  const _handler = {};\n\n  // merge options with defaults\n  Object.keys(_defaults).forEach(key => {\n    _handler[key] = options[key] || _defaults[key];\n  });\n\n  // normalize timeout value, even if it is zero\n  _handler.refreshTimeout = typeof options.refreshTimeout === 'number'\n    ? options.refreshTimeout\n    : _defaults.refreshTimeout;\n\n  // normalize elements\n  _methods.forEach(method => {\n    if (typeof _handler[method] === 'string') {\n      _handler[method] = document.querySelector(_handler[method]);\n    }\n  });\n\n  // attach events lazily\n  if (!_shared.events) {\n    _shared.events = _setupEvents();\n  }\n\n  _handler.contains = target => {\n    return _handler.triggerElement.contains(target);\n  };\n\n  _handler.destroy = () => {\n    // stop pending any pending callbacks\n    clearTimeout(_shared.timeout);\n\n    // remove handler from shared state\n    _shared.handlers.splice(_handler.offset, 1);\n  };\n\n  return _handler;\n}\n\n// public API\nexport default {\n  setPassiveMode(isPassive) {\n    _shared.passive = isPassive;\n  },\n  destroyAll() {\n    if (_shared.events) {\n      _shared.events.destroy();\n      _shared.events = null;\n    }\n\n    _shared.handlers.forEach(h => {\n      h.destroy();\n    });\n  },\n  init(options = {}) {\n    const handler = _setupHandler(options);\n\n    // store offset for later unsubscription\n    handler.offset = _shared.handlers.push(handler) - 1;\n\n    return handler;\n  },\n\n  // export utils for testing\n  _: {\n    setupHandler: _setupHandler,\n    setupEvents: _setupEvents,\n    setupDOM: _ptr.setupDOM,\n    onReset: _ptr.onReset,\n    update: _ptr.update,\n  },\n};\n"],"names":["const","_defaults","distThreshold","distMax","distReload","distIgnore","bodyOffset","mainElement","triggerElement","ptrElement","classPrefix","cssProp","iconArrow","iconRefreshing","instructionsPullToRefresh","instructionsReleaseToRefresh","instructionsRefreshing","refreshTimeout","getMarkup","getStyles","onInit","onRefresh","location","reload","resistanceFunction","t","Math","min","shouldPullToRefresh","window","scrollY","_methods","_shared","pullStartY","pullMoveY","handlers","styleEl","events","dist","state","timeout","distResisted","supportsPassive","addEventListener","e","_ptr","setupDOM","handler","ptr","document","createElement","body","parentNode","insertBefore","firstChild","classList","add","innerHTML","replace","setAttribute","head","appendChild","textContent","onReset","remove","style","setTimeout","removeChild","update","iconEl","querySelector","textEl","_setupEvents","_el","_onTouchStart","target","filter","h","contains","enable","touches","screenY","clearTimeout","_onTouchMove","distExtra","preventDefault","_onTouchEnd","retval","then","length","_onScroll","toggle","_passiveSettings","passive","undefined","onTouchEnd","onTouchStart","onTouchMove","onScroll","destroy","removeEventListener","_setupHandler","options","_handler","Object","keys","forEach","key","method","splice","offset","setPassiveMode","isPassive","destroyAll","init","push","_","setupHandler","setupEvents"],"mappings":"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"}